<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mission Management</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, push, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAbkgmgqYqatkhmfDKnLHa4S52z9Jcz1lw",
      authDomain: "mission-9dd26.firebaseapp.com",
      databaseURL: "https://mission-9dd26-default-rtdb.firebaseio.com",
      projectId: "mission-9dd26",
      storageBucket: "mission-9dd26.appspot.com",
      messagingSenderId: "1080303837931",
      appId: "1:1080303837931:web:9b5ed2486bd6a2e70914ae",
      measurementId: "G-NWFV3RFGKV"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.firebase = { db, ref, push, set, get, remove, onValue };
  </script>
  <style>
    body { font-family: Arial, sans-serif; margin: 1rem; background: #f5f5f5; }
    input, button, textarea {
      margin-top: 0.5rem;
      padding: 0.5rem;
      font-size: 1rem;
    }
    #chatMessages, #commsLog, #fileList {
      border: 1px solid #ccc;
      height: 150px;
      overflow-y: auto;
      padding: 0.5rem;
    }
    #loginSection {
      max-width: 400px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    #mainApp { display: none; }
    .mission-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: #f9f9f9;
      border: 1px solid #ccc;
      margin-bottom: 0.5rem;
    }
    .deleteBtn {
      background-color: red;
      color: white;
      padding: 0.3rem 0.6rem;
      border: none;
    }
  </style>
</head>
<body>
<div id="loginSection">
  <h2>Login</h2>
  <label>Username:</label>
  <input type="text" id="usernameInput" />
  <label>Password:</label>
  <input type="password" id="passwordInput" />
  <button id="loginBtn">Login</button>
  <p id="loginError" style="color: red;"></p>
  <p>Donâ€™t have an account? Email <a href="mailto:Kendrick.uhles@cawgcap.org">Kendrick Uhles</a> and CC <a href="mailto:Laramie.Uhles@cawgcap.org">Laramie Uhles</a> with your desired username and password.</p>
</div>

<div id="mainApp">
  <button id="createMissionBtn" style="float:right;">Create Mission</button>
  <h2>Missions</h2>
  <input type="text" id="missionSearch" placeholder="Search missions..." />
  <div id="missionList"></div>

  <h3 id="currentMissionTitle"></h3>
  <div id="chatMessages"></div>
  <div id="commsLog"></div>
  <ul id="fileList"></ul>
</div>

<script>
  const USERS = {
    "CommanderK": "SecurePass123",
    "LaramieU": "RadioOps456",
    "TestUser": "TestPass789"
  };

  let currentMission = null;
  const db = window.firebase.db;
  const { ref, push, set, get, remove, onValue } = window.firebase;
  const missions = [];

  const missionListEl = document.getElementById('missionList');
  const currentMissionTitleEl = document.getElementById('currentMissionTitle');
  const chatMessagesEl = document.getElementById('chatMessages');
  const commsLogEl = document.getElementById('commsLog');
  const fileListEl = document.getElementById('fileList');

  function loadMissions() {
    const missionsRef = ref(db, 'missions');
    onValue(missionsRef, snapshot => {
      missions.length = 0;
      missionListEl.innerHTML = '';
      snapshot.forEach(child => {
        const data = child.val();
        data.key = child.key;
        missions.push(data);
      });
      renderMissionList();
    });
  }

  function saveMission(mission) {
    const newRef = push(ref(db, 'missions'));
    return set(newRef, mission);
  }

  function deleteMission(missionKey) {
    return remove(ref(db, `missions/${missionKey}`));
  }

  document.getElementById('loginBtn').onclick = () => {
    console.log("Login button clicked");
    const user = document.getElementById('usernameInput').value.trim();
    const pass = document.getElementById('passwordInput').value;
    if (USERS[user] === pass) {
      console.log("Login successful");
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      loadMissions();
    } else {
      console.log("Login failed");
      document.getElementById('loginError').textContent = "Incorrect username or password.";
    }
  };

  document.getElementById('createMissionBtn').onclick = () => {
    const name = prompt('Enter mission name:');
    if (!name) return;
    const number = prompt('Enter mission number:');
    if (!number) return;
    const newMission = { name, number, chat: [], comms: [], files: [] };
    saveMission(newMission);
  };

  function renderMissionList() {
    const filter = document.getElementById('missionSearch').value.toLowerCase();
    missionListEl.innerHTML = '';
    missions.filter(m => `${m.name} ${m.number}`.toLowerCase().includes(filter)).forEach((m, index) => {
      const div = document.createElement('div');
      div.className = 'mission-row';

      const label = document.createElement('span');
      label.textContent = `${m.name} (${m.number})`;

      const viewBtn = document.createElement('button');
      viewBtn.textContent = 'View';
      viewBtn.onclick = () => {
        currentMission = m;
        currentMissionTitleEl.textContent = `${m.name} (${m.number})`;
        chatMessagesEl.textContent = '';
        commsLogEl.textContent = '';
        fileListEl.innerHTML = '';
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Delete';
      deleteBtn.className = 'deleteBtn';
      deleteBtn.onclick = () => {
        const confirmDelete = prompt('Type DELETE to confirm deleting this mission');
        if (confirmDelete === 'DELETE') {
          deleteMission(m.key);
        }
      };

      div.appendChild(label);
      div.appendChild(viewBtn);
      div.appendChild(deleteBtn);
      missionListEl.appendChild(div);
    });
  }
</script>
</body>
</html>
