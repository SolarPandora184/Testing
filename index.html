<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission Management</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>
    :root {
      --bg: #12161d;
      --panel: #1e232b;
      --accent: #2d333b;
      --text: #ffffff;
      --muted: #a0a0a0;
      --highlight: #3a8eed;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    /* --- Added: mission list styles --- */
    #missionListView {
      padding: 1rem;
    }
    #missionListView h1 {
      margin-bottom: 1rem;
    }
    .mission-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    .mission {
      background: var(--panel);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .mission:hover {
      background: var(--accent);
    }
    .mission h2 {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
    }
    .mission p {
      margin: 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    /* --- End added mission list styles --- */

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      height: 100vh;
      gap: 10px;
      padding: 10px;
      align-items: stretch;
      justify-items: stretch;
    }
    .panel {
      background: var(--panel);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
      min-height: 0;
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 1.2rem;
      border-bottom: 1px solid var(--accent);
      padding-bottom: 5px;
    }
    #map {
      flex-grow: 1;
      width: 100%;
      border-radius: 8px;
      min-height: 0;
    }
    #chatMessages, #commsLog, #fileList {
      flex: 1;
      overflow-y: auto;
      background: var(--accent);
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    input, button, textarea {
      background: #2a2f38;
      color: white;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 0.5rem;
      margin-top: 5px;
    }
    #fileList li { padding: 5px 0; border-bottom: 1px solid #444; }
    #chatInput, #commsInput { width: 100%; }
    #profileBtn {
      position: fixed;
      bottom: 15px;
      right: 15px;
      background: var(--highlight);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
    #logoutBtn, #voiceBtn {
      position: fixed;
      top: 15px;
      background: red;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
    }
    #logoutBtn {
      right: 15px;
    }
    #voiceBtn {
      right: 115px;
      background: green;
    }
    #profileSearch {
      display: none;
      position: fixed;
      bottom: 60px;
      right: 15px;
      background: var(--panel);
      padding: 1rem;
      border-radius: 8px;
      width: 300px;
      z-index: 1000;
    }
    #statusBar {
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    #profileResult ul {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      margin: 0;
      padding: 0;
      list-style: none;
    }
    #profileResult li {
      background: var(--accent);
      padding: 4px;
      border-radius: 4px;
    }

    /* --- Added: dashboard container hidden by default --- */
    #mainApp {
      display: none;
    }

    /* --- Added: back button to return to mission list --- */
    #backBtn {
      position: fixed;
      top: 15px;
      left: 15px;
      background: var(--highlight);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1100;
      display: none;
    }
  </style>
</head>
<body>

  <!-- Mission Selection View (ADDED) -->
  <div id="missionListView">
    <h1>Select a Mission</h1>
    <div id="missionList" class="mission-list">Loading missions...</div>
  </div>

  <!-- Back Button (ADDED) -->
  <button id="backBtn">Back to Missions</button>

  <!-- Existing Dashboard (now wrapped in mainApp) -->
  <div class="grid" id="mainApp">
    <div class="panel">
      <h2>Incident Command</h2>
      <div id="chatMessages"></div>
      <input type="text" id="chatInput" placeholder="Message #operations" />
      <button onclick="sendChat()">Send</button>
    </div>

    <div class="panel">
      <h2>Unit Tracking</h2>
      <div id="statusBar">Loading CAP aircraft...</div>
      <div id="map"></div>
    </div>

    <div class="panel">
      <h2>Comms Log</h2>
      <div id="commsLog"></div>
      <input type="text" id="commsInput" placeholder="Log entry" />
      <button onclick="logComms()">Log</button>
    </div>

    <div class="panel">
      <h2>File Sharing</h2>
      <input type="file" id="fileUpload" />
      <button onclick="uploadFile()">Upload</button>
      <ul id="fileList"></ul>
    </div>
  </div>

  <button id="profileBtn" onclick="toggleProfileSearch()">Search Profiles</button>
  <button id="logoutBtn" onclick="logoutUser()" style="display:none">Logout</button>
  <button id="voiceBtn" onclick="toggleVoiceChannel()" style="display:none">Join Voice</button>
  <div id="profileSearch">
    <input type="text" id="searchBox" placeholder="Search by name..." />
    <div id="profileResult" style="margin-top:10px"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const capApp = firebase.initializeApp({
      apiKey: "AIzaSyDRaTNFRTV0SLdUgfjVnO0CQT44yuElDh0",
      authDomain: "test-data-base-6da39.firebaseapp.com",
      projectId: "test-data-base-6da39",
      storageBucket: "test-data-base-6da39.appspot.com",
      messagingSenderId: "342303847512",
      appId: "1:342303847512:web:74688627a824be8130462d",
      measurementId: "G-7XN8HCS0G1",
      databaseURL: "https://test-data-base-6da39-default-rtdb.firebaseio.com"
    }, "capApp");

    const dbCAP = capApp.database();
    const db = firebase.initializeApp({
      apiKey: "AIzaSyAbkgmgqYqatkhmfDKnLHa4S52z9Jcz1lw",
      authDomain: "mission-9dd26.firebaseapp.com",
      databaseURL: "https://mission-9dd26-default-rtdb.firebaseio.com",
      projectId: "mission-9dd26",
      storageBucket: "mission-9dd26.appspot.com",
      messagingSenderId: "1080303837931",
      appId: "1:1080303837931:web:9b5ed2486bd6a2e70914ae",
      measurementId: "G-NWFV3RFGKV"
    }, "missionApp").database();

    // Elements
    const missionListView = document.getElementById('missionListView');
    const missionListEl = document.getElementById('missionList');
    const mainApp = document.getElementById('mainApp');
    const backBtn = document.getElementById('backBtn');

    const chatMessagesEl = document.getElementById('chatMessages');
    const commsLogEl = document.getElementById('commsLog');
    const fileListEl = document.getElementById('fileList');

    let map;
    let markers = {};

    let currentUser = null;
    let missionKey = null;

    // Hardcoded users
    const users = {
      "Kendrick Uhles": "Ku2023!@",
      "Laramie Uhles": "Missions2025",
      "Ryan Uhles": "IC2025!"
    };

    // --- Load Missions List ---
    function loadMissionList() {
      missionListEl.textContent = 'Loading missions...';
      db.ref('missions').once('value').then(snapshot => {
        const missions = snapshot.val();
        if (!missions) {
          missionListEl.textContent = 'No missions found.';
          return;
        }
        missionListEl.innerHTML = '';
        Object.entries(missions).forEach(([key, mission]) => {
          const div = document.createElement('div');
          div.className = 'mission';
          div.tabIndex = 0;
          div.innerHTML = `<h2>${mission.name || key}</h2><p>Mission Key: ${key}</p>`;
          div.onclick = () => selectMission(key);
          div.onkeypress = e => { if (e.key === 'Enter') selectMission(key); };
          missionListEl.appendChild(div);
        });
      }).catch(err => {
        missionListEl.textContent = 'Failed to load missions.';
        console.error(err);
      });
    }

    // --- Select a mission ---
    function selectMission(key) {
      missionKey = key;
      missionListView.style.display = 'none';
      mainApp.style.display = 'grid';
      backBtn.style.display = 'block';

      document.getElementById("logoutBtn").style.display = "block";
      document.getElementById("voiceBtn").style.display = "block";

      initializeMap();
      setupListeners();
    }

    backBtn.onclick = () => {
      missionKey = null;

      // Remove listeners & clear UI
      cleanupListeners();

      mainApp.style.display = 'none';
      missionListView.style.display = 'block';
      backBtn.style.display = 'none';

      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("voiceBtn").style.display = "none";

      // Clear map markers & reset map
      if (map) {
        Object.values(markers).forEach(m => map.removeLayer(m));
        markers = {};
        map.setView([37.5, -119], 5);
      }

      chatMessagesEl.innerHTML = '';
      commsLogEl.innerHTML = '';
      fileListEl.innerHTML = '';
    };

    // --- Initialize map ---
    function initializeMap() {
      if (!map) {
        map = L.map('map').setView([37.5, -119], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
      } else {
        map.invalidateSize();
      }
    }

    // --- Firebase listeners references ---
    let chatRef = null;
    let commsRef = null;
    let filesRef = null;
    let voiceRef = null;
    let voiceUsersRef = null;
    let signalsRefs = {};

    // --- Setup listeners for the selected mission ---
    async function setupListeners() {
      if (!missionKey) return;

      // Chat listener
      chatRef = db.ref(`missions/${missionKey}/chat`);
      chatRef.on('value', snap => {
        const data = snap.val();
        chatMessagesEl.innerHTML = '';
        if (data) Object.values(data).forEach(msg => {
          const div = document.createElement('div');
          div.textContent = `[${msg.time || '??'}] ${msg.user || 'Unknown'}: ${msg.text || msg}`;
          chatMessagesEl.appendChild(div);
        });
        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
      });

      // Comms listener
      commsRef = db.ref(`missions/${missionKey}/comms`);
      commsRef.on('value', snap => {
        const data = snap.val();
        commsLogEl.innerHTML = '';
        if (data) Object.values(data).forEach(entry => {
          const div = document.createElement('div');
          div.textContent = `${entry.time || '??'} - ${entry.text || entry}`;
          commsLogEl.appendChild(div);
        });
        commsLogEl.scrollTop = commsLogEl.scrollHeight;
      });

      // Files listener
      filesRef = db.ref(`missions/${missionKey}/files`);
      filesRef.on('value', snap => {
        const data = snap.val();
        fileListEl.innerHTML = '';
        if (data) Object.values(data).forEach(file => {
          const li = document.createElement('li');
          li.textContent = file.name;
          fileListEl.appendChild(li);
        });
      });

      // Voice users listener
      voiceUsersRef = db.ref(`missions/${missionKey}/voice/users`);
      voiceUsersRef.on('value', snap => {
        const users = snap.val() || {};
        // You can update voice UI here if you want
      });

      // Voice signaling listeners
      voiceRef = db.ref(`missions/${missionKey}/voice/signals`);
      voiceRef.on('child_added', snap => {
        const signalData = snap.val();
        if (signalData.from === currentUser) return; // Ignore own signals

        const from = signalData.from;
        if (!signalsRefs[from]) {
          setupPeer(from);
        }
        signalsRefs[from].signal(signalData.signal);
      });

      // Aircraft tracking (CAP)
      startAircraftTracking();
    }

    // --- Cleanup listeners ---
    function cleanupListeners() {
      if (chatRef) chatRef.off();
      if (commsRef) commsRef.off();
      if (filesRef) filesRef.off();
      if (voiceUsersRef) voiceUsersRef.off();
      if (voiceRef) voiceRef.off();
      Object.values(signalsRefs).forEach(peer => peer.destroy());
      signalsRefs = {};
    }

    // --- Chat send ---
    function getTimeStamp() {
      const now = new Date();
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    function sendChat() {
      const input = document.getElementById('chatInput');
      const msg = input.value.trim();
      if (!msg) return;
      if (!currentUser) return alert('Please login first.');
      db.ref(`missions/${missionKey}/chat`).push({ text: msg, time: getTimeStamp(), user: currentUser });
      input.value = '';
    }

    // --- Comms log ---
    function logComms() {
      const input = document.getElementById('commsInput');
      const entry = input.value.trim();
      if (!entry) return;
      db.ref(`missions/${missionKey}/comms`).push({ text: entry, time: getTimeStamp() });
      input.value = '';
    }

    // --- File upload ---
    function uploadFile() {
      const fileInput = document.getElementById('fileUpload');
      if (!fileInput.files.length) return;
      const file = fileInput.files[0];
      // Here you would normally upload to storage, but for now just push filename to DB
      db.ref(`missions/${missionKey}/files`).push({ name: file.name });
      fileInput.value = '';
    }

    // --- Aircraft Tracking ---
    let aircraftDataRef = null;
    let aircraftInterval = null;
    function startAircraftTracking() {
      // Cleanup previous if any
      if (aircraftDataRef) aircraftDataRef.off();
      if (aircraftInterval) clearInterval(aircraftInterval);

      document.getElementById('statusBar').textContent = 'Loading CAP aircraft...';

      aircraftDataRef = dbCAP.ref('aircraft');
      aircraftDataRef.on('value', snap => {
        const aircraft = snap.val() || {};
        updateAircraftMarkers(aircraft);
      });

      // Poll periodically if needed
      aircraftInterval = setInterval(() => {
        aircraftDataRef.once('value').then(snap => {
          updateAircraftMarkers(snap.val() || {});
        });
      }, 60000);
    }

    function updateAircraftMarkers(aircraft) {
      // Remove all markers first
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};

      const capAircraft = Object.values(aircraft).filter(a => a.org === 'CAP');

      capAircraft.forEach(a => {
        if (a.lat && a.lon) {
          const marker = L.marker([a.lat, a.lon]).addTo(map).bindPopup(`${a.callsign || a.hex}`);
          markers[a.hex] = marker;
        }
      });

      document.getElementById('statusBar').textContent = `Tracking ${capAircraft.length} CAP aircraft`;
    }

    // --- Profile Search ---
    const profileBtn = document.getElementById('profileBtn');
    const profileSearch = document.getElementById('profileSearch');
    const searchBox = document.getElementById('searchBox');
    const profileResult = document.getElementById('profileResult');

    profileBtn.onclick = () => {
      profileSearch.style.display = profileSearch.style.display === 'block' ? 'none' : 'block';
      searchBox.value = '';
      profileResult.innerHTML = '';
    };

    searchBox.oninput = () => {
      const val = searchBox.value.toLowerCase().trim();
      if (!val) {
        profileResult.innerHTML = '';
        return;
      }
      db.ref('profiles').once('value').then(snap => {
        const profiles = snap.val() || {};
        const results = Object.values(profiles).filter(p =>
          (p.name && p.name.toLowerCase().includes(val)) ||
          (p.rank && p.rank.toLowerCase().includes(val)) ||
          (p.email && p.email.toLowerCase().includes(val))
        );
        profileResult.innerHTML = results.length ?
          `<ul>${results.map(p => `<li>${p.rank} ${p.name} - ${p.email}</li>`).join('')}</ul>` :
          'No profiles found.';
      });
    };

    // --- Voice Channel ---

    let localStream = null;
    let peers = {};
    let voiceRefLocal = null;

    async function startVoice() {
      if (localStream) return;
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log('Voice stream started');
        setupVoiceSignaling();
      } catch (e) {
        alert('Could not get microphone access');
      }
    }

    function stopVoice() {
      if (!localStream) return;
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
      Object.values(peers).forEach(p => p.destroy());
      peers = {};
      if (voiceRefLocal) {
        voiceRefLocal.remove();
        voiceRefLocal = null;
      }
      db.ref(`missions/${missionKey}/voice/users/${currentUser}`).remove();
      console.log('Voice stream stopped');
    }

    function toggleVoiceChannel() {
      if (localStream) {
        stopVoice();
        document.getElementById('voiceBtn').textContent = 'Join Voice';
      } else {
        startVoice();
        document.getElementById('voiceBtn').textContent = 'Leave Voice';
      }
    }

    function setupVoiceSignaling() {
      if (!missionKey) return;

      voiceRefLocal = db.ref(`missions/${missionKey}/voice/users/${currentUser}`);
      voiceRefLocal.set(true);
      voiceRefLocal.onDisconnect().remove();

      const signalsRef = db.ref(`missions/${missionKey}/voice/signals`);

      // Listen for signals to us
      signalsRef.on('child_added', snap => {
        const { from, to, signal } = snap.val();
        if (to !== currentUser) return;

        if (!peers[from]) {
          peers[from] = new SimplePeer({ initiator: false, trickle: false, stream: localStream });
          peers[from].on('signal', data => {
            signalsRef.push({ from: currentUser, to: from, signal: data });
          });
          peers[from].on('stream', remoteStream => {
            // play remote audio
            playAudioStream(remoteStream);
          });
        }
        peers[from].signal(signal);
      });

      // Connect to existing users
      db.ref(`missions/${missionKey}/voice/users`).once('value').then(snap => {
        const users = snap.val() || {};
        Object.keys(users).forEach(user => {
          if (user !== currentUser && !peers[user]) {
            peers[user] = new SimplePeer({ initiator: true, trickle: false, stream: localStream });
            peers[user].on('signal', data => {
              signalsRef.push({ from: currentUser, to: user, signal: data });
            });
            peers[user].on('stream', remoteStream => {
              playAudioStream(remoteStream);
            });
          }
        });
      });
    }

    function playAudioStream(stream) {
      const audio = new Audio();
      audio.srcObject = stream;
      audio.play();
    }

    // --- Login & Logout ---
    function loginUser() {
      currentUser = prompt('Enter your username (Kendrick Uhles, Laramie Uhles, Ryan Uhles):');
      if (!currentUser || !users[currentUser]) {
        alert('Invalid user.');
        currentUser = null;
        return false;
      }
      const pass = prompt('Enter password:');
      if (users[currentUser] !== pass) {
        alert('Invalid password.');
        currentUser = null;
        return false;
      }
      alert(`Welcome ${currentUser}`);
      document.getElementById('logoutBtn').style.display = 'block';
      return true;
    }

    function logoutUser() {
      if (localStream) stopVoice();
      currentUser = null;
      alert('Logged out');
      document.getElementById('logoutBtn').style.display = 'none';
      document.getElementById('voiceBtn').style.display = 'none';
      // Show mission selection and hide app
      missionKey = null;
      cleanupListeners();
      mainApp.style.display = 'none';
      missionListView.style.display = 'block';
      backBtn.style.display = 'none';
    }

    // --- Initialization ---
    window.onload = () => {
      loadMissionList();
      if (loginUser()) {
        // Initially hide dashboard
        mainApp.style.display = 'none';
        backBtn.style.display = 'none';
      }
    };
  </script>
</body>
</html>
